name: NodeJS CI

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master", "develop" ]

permissions: read-all

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # See https://nodejs.org/en/about/releases/
        node-version: [ 16.x ]

    env:
      SOL_AST_COMPILER_CACHE: ${{ github.workspace }}/.compiler_cache

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Use NodeJS ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install and lint
        run: |
          npm install
          npm link
          npm run lint

      # See https://github.com/ethereum/solc-bin
      # See https://binaries.soliditylang.org/
      # Also, remove list files and one rarely used compiler to still test downloading on-demand.
      - name: Pre-download compilers from historical builds archive
        run: |
          scribble --download-compilers native wasm
          find $SOL_AST_COMPILER_CACHE -name 'list.json' -delete
          find $SOL_AST_COMPILER_CACHE -name '*v0.5.17*' -delete

      - name: Test and generate coverage report
        run: |
          npm run test:ci
          npm run coverage

      - name: Upload coverage to CodeCov
        uses: codecov/codecov-action@v3
        with:
          name: codecov-umbrella
          directory: ./coverage/
          fail_ci_if_error: true
          verbose: true

  notify-slack:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - id: non_merge_commit_message
        run: echo "commit_message=$(git log --pretty=format:'%s' --no-merges -n 1)" >> $GITHUB_OUTPUT
        shell: bash
      - name: Send slack Notification
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "project": "$PROJECT",
              "env": "$ENV",
              "version": "",
              "actor": "$ACTOR",
              "commit_sha": "$COMMIT_SHA",
              "commit_message": "$COMMIT_MESSAGE",
              "commit_link": "$COMMIT_LINK",
              "message": ""
            }
        env:
          PROJECT: ${{ github.repository }}
          ENV: ${{ github.ref_name }}
          ACTOR: ${{ github.triggering_actor }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MESSAGE: ${{ steps.non_merge_commit_message.outputs.commit_message }}
          COMMIT_LINK: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          SLACK_WEBHOOK_URL: ${{ secrets.slack_webhook_url }}
